<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>一文了解 WebSocket 协议 | 谈笑风生间</title><meta name="author" content="谈笑风生间"><meta name="copyright" content="谈笑风生间"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="为什么需要 WebSocket 短轮训-&gt;长轮训-&gt;基于流-&gt;WebSocket  TCP 长连接就是 WebSocket 的基础，但是如果是 HTTP 的长连接，本质上还是 Request&#x2F;Response 消息对，仍然会造成资源的浪费、实时性不强等问题 特点   建立在 TCP 之上   与 HTTP 有良好兼容性   没有同源限制，客户端可以与任意服务器通信   标识符是w">
<meta property="og:type" content="article">
<meta property="og:title" content="一文了解 WebSocket 协议">
<meta property="og:url" content="https://makonike.github.io/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="谈笑风生间">
<meta property="og:description" content="为什么需要 WebSocket 短轮训-&gt;长轮训-&gt;基于流-&gt;WebSocket  TCP 长连接就是 WebSocket 的基础，但是如果是 HTTP 的长连接，本质上还是 Request&#x2F;Response 消息对，仍然会造成资源的浪费、实时性不强等问题 特点   建立在 TCP 之上   与 HTTP 有良好兼容性   没有同源限制，客户端可以与任意服务器通信   标识符是w">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/title.png">
<meta property="article:published_time" content="2023-05-06T14:56:30.000Z">
<meta property="article:modified_time" content="2023-05-07T07:31:00.598Z">
<meta property="article:author" content="谈笑风生间">
<meta property="article:tag" content="网络">
<meta property="article:tag" content="协议">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/title.png"><link rel="shortcut icon" href="https://i.loli.net/2021/10/03/N9cpBZe75b2tQfz.png"><link rel="canonical" href="https://makonike.github.io/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '一文了解 WebSocket 协议',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-07 15:31:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_8d5l8fzk5b87iudi.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/title/avatar1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/title.png')"><nav id="nav"><span id="blog-info"><a href="/" title="谈笑风生间"><span class="site-name">谈笑风生间</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">一文了解 WebSocket 协议</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T14:56:30.000Z" title="发表于 2023-05-06 22:56:30">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-07T07:31:00.598Z" title="更新于 2023-05-07 15:31:00">2023-05-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97/">学习日志</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B8%80%E6%96%87%E7%B3%BB%E5%88%97/">一文系列</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="一文了解 WebSocket 协议"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="为什么需要-WebSocket">为什么需要 WebSocket</h2>
<p>短轮训-&gt;长轮训-&gt;基于流-&gt;WebSocket<br>
<img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/0.png" alt=""><br>
TCP 长连接就是 WebSocket 的基础，但是如果是 HTTP 的长连接，本质上还是 Request/Response 消息对，仍然会造成资源的浪费、实时性不强等问题</p>
<h2 id="特点">特点</h2>
<ul>
<li>
<p>建立在 TCP 之上</p>
</li>
<li>
<p>与 HTTP 有良好兼容性</p>
</li>
<li>
<p>没有同源限制，客户端可以与任意服务器通信</p>
</li>
<li>
<p>标识符是ws/wss，服务器地址是URL</p>
</li>
<li>
<p>可以发送文本和二进制数据</p>
</li>
<li>
<p>数据格式轻量，性能开销小，通信高效。连接创建后，ws 客户端、服务端进行数据交换时，协议控制的数据包<strong>头部较小</strong>。在不包含头部的情况下，服务端到客户端的包头<strong>只有 2~10 字节</strong>（取决于数据包长度），客户端到服务端的的话，需要加上额外的 4 字节的掩码。而 HTTP 协议每次通信都需要携带完整的头部；</p>
</li>
</ul>
<h2 id="建立连接">建立连接</h2>
<p>WebSocket 的目的是取代 HTTP 在双向通信的场景下使用，所以有些实现方式也是基于 HTTP 的（比如默认端口为 80/443），有向下兼容的意思。</p>
<h3 id="客户端发起协议升级">客户端发起协议升级</h3>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080 // 前两行都和HTTP的Request起始行一样</span><br><span class="line">Origin:http://127.0.0.1:3000   // 标明原始域，防止跨站攻击</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade // 表示升级协议。</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket    // 表示升级到websocket。upgrade是HTTP1.1用来定义转换协议的header域</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span><span class="punctuation">: </span>13 // 表示websocket的版本</span><br><span class="line">// 如果服务端不支持该版本，则返回一个Sec-WebSocket-Versionheader，包含服务端支持的版本号</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span><span class="punctuation">: </span>w4v7O6xFTi36lq3RNcgctw== </span><br><span class="line">// 与后文服务端响应首部的Sec-WebSocket-Accept配套，提供基本的防护。如恶意连接或无意义连接</span><br></pre></td></tr></table></figure>
<h3 id="服务端响应协议升级">服务端响应协议升级</h3>
<p>101 表示服务器收到了客户端切换协议的请求，并且同意切换到此协议。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line">Connection:Upgrade</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>websocket</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span><span class="punctuation">: </span>Oy4NRAQ13jhfONC7bP8dTKb4PTU=</span><br></pre></td></tr></table></figure>
<p>服务端回应的 HTTP 状态码只能在握手阶段使用。过了握手阶段后，就只能采用特定的错误码。</p>
<h3 id="Sec-WebSocket-Accept-计算">Sec-WebSocket-Accept 计算</h3>
<p>根据客户端请求首部的 Sec-WebSocket-Key 进行计算。</p>
<ul>
<li>
<p>将 Sec-WebSocket-Key 跟 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 拼接</p>
</li>
<li>
<p>通过 SHA1 计算出摘要，并转成 base64 字符串</p>
</li>
</ul>
<blockquote>
<p>toBase64( sha1( Sec-WebSocket-Key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 ) )</p>
</blockquote>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/1.png" alt=""></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/2.png" alt=""></p>
<h3 id="Sec-WebSocket-Key-Accept-作用">Sec-WebSocket-Key/Accept 作用</h3>
<p>主要用于提供基础防护，减少恶意连接和意外连接</p>
<ul>
<li>
<p>为了避免服务端收到非法 websocket 连接（如 http 客户端不小心请求 websocket 服务）。</p>
</li>
<li>
<p>确保服务端能理解 websocket 连接，客户端能通过 Sec-WebSocket-Key 来确保认识 ws 协议（服务端不仅需要处理 Sec-WebSocket-Key，还需要实现 ws 协议，否则没有意义）。</p>
</li>
<li>
<p>在浏览器中发起 ajax 请求，设置 Header 时，Sec-WebSocket-Key 以及其他相关 header 是被禁止的，防止 ajax 请求意外请求升级升级。</p>
<ul>
<li>以“Sec-”开头的 Header 可以避免被浏览器脚本读取到，这样攻击者就不能利用 XMLHttpRequest 伪造 WebSocket 请求来执行跨协议攻击，因为 XMLHttpRequest 接口不允许设置 Sec-开头的 Header。</li>
</ul>
</li>
<li>
<p>可以防止反向代理返回错误的数据。</p>
</li>
<li>
<p>Sec-WebSocket-Key 主要目的不是为了确保数据安全性，因为转换公式时公开的，主要预防一些常见的非故意意外情况。</p>
</li>
</ul>
<p>只能带来基本保证，无法确保连接安全、数据安全、客户端/服务端是否合法。</p>
<h3 id="Sec-WebSocket-Protocol-子协议">Sec-WebSocket-Protocol 子协议</h3>
<p>详情见：<a target="_blank" rel="noopener" href="https://medium.com/@lancers/websocket-api-sec-websocket-protocol-subprotocol-header-support-277e34164537">WebSocket API: Sec-WebSocket-Protocol (Subprotocol) header support</a></p>
<p>在笔者初识子协议时，曾用其作为 Token 的存放位置 qwq，因为 WebSocket 无法自定义请求头。实际生产场景中，可以通过 SubProtocol 区分不同的应用场景。比如笔者的应用场景有推送、协同两种，就能自定义 SubProtocol 去区分。</p>
<h2 id="数据帧格式">数据帧格式</h2>
<p>通信的最小单位是帧 frame，由一个或多个帧组合为一条完整的消息 message</p>
<ul>
<li>
<p>发送：将消息切割为多个帧，并发送给服务端</p>
</li>
<li>
<p>接收：组成一个完整消息</p>
</li>
</ul>
<p>详细定义：<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">RFC ft-ietf-hybi-thewebsocketprotocol: The WebSocket Protocol</a></p>
<p>数据帧统一格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="comment">-------+-+-------------+-------------------------------+</span></span><br><span class="line"><span class="operator">|</span>F<span class="operator">|</span>R<span class="operator">|</span>R<span class="operator">|</span>R<span class="operator">|</span> opcode<span class="operator">|</span>M<span class="operator">|</span> Payload len <span class="operator">|</span>    Extended payload length    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>I<span class="operator">|</span>S<span class="operator">|</span>S<span class="operator">|</span>S<span class="operator">|</span>  (<span class="number">4</span>)  <span class="operator">|</span>A<span class="operator">|</span>     (<span class="number">7</span>)     <span class="operator">|</span>             (<span class="number">16</span><span class="operator">/</span><span class="number">64</span>)           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>N<span class="operator">|</span>V<span class="operator">|</span>V<span class="operator">|</span>V<span class="operator">|</span>       <span class="operator">|</span>S<span class="operator">|</span>             <span class="operator">|</span>   (if payload len<span class="operator">=</span><span class="operator">=</span><span class="number">126</span><span class="operator">/</span><span class="number">127</span>)   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">|</span><span class="number">1</span><span class="operator">|</span><span class="number">2</span><span class="operator">|</span><span class="number">3</span><span class="operator">|</span>       <span class="operator">|</span>K<span class="operator">|</span>             <span class="operator">|</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="operator">-</span><span class="operator">+</span><span class="comment">-------+-+-------------+ - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="operator">|</span>     Extended payload length continued, if payload len <span class="operator">=</span><span class="operator">=</span> <span class="number">127</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">+</span><span class="comment">-------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span>Masking<span class="operator">-</span>key, if MASK <span class="keyword">set</span> <span class="keyword">to</span> <span class="number">1</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Masking<span class="operator">-</span>key (continued)       <span class="operator">|</span>          Payload Data         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------- - - - - - - - - - - - - - - - +</span></span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line"><span class="operator">+</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">-</span> <span class="operator">+</span></span><br><span class="line"><span class="operator">|</span>                     Payload Data continued ...                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure>
<ul>
<li>FIN 1bit</li>
</ul>
<p>如果为 1，表示这是该消息的最后一个分片。否则为 0</p>
<ul>
<li>RSV1, RSV2, RSV3 3bit</li>
</ul>
<p>一般情况下为全 0，用于客户端与服务端协商采用 WebSocket 扩展，值由扩展进行定义，如果出现非 0 值且没有使用扩展，则连接出错</p>
<ul>
<li>Opcode 4bit</li>
</ul>
<p>操作代码，决定该如何解析后续 payload。如果操作代码未知，则接收端应断开连接。可选如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x0：表示一个延续帧。当Opcode为0时，表示本次数据传输采用了数据分片，当前收到的数据帧为其中一个数据分片。</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x1：表示这是一个文本帧（frame）</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x2：表示这是一个二进制帧（frame）</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x3-7：保留的操作代码，用于后续定义的非控制帧。</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x8：表示连接断开。</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x9：表示这是一个ping操作。</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">xA：表示这是一个pong操作。</span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">xB-F：保留的操作代码，用于后续定义的控制帧。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Mask 1bit</li>
</ul>
<p>表示是否要对 data payload 进行掩码操作。从客户端发向服务端要，从服务端发向客户端不用。当服务端接收到未进行掩码操作的数据，服务端应该断开连接</p>
<p>Mask 为 1，Masking-key 中应该定义一个掩码键 masking key，并用其对 data payload 进行反掩码。所有客户端发到服务端的帧，mask 都为 1</p>
<ul>
<li>Payload length 7bit</li>
</ul>
<p>data payload 的长度，单位为字节。如果 patload length == x</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x为0~126：数据的长度为x字节。</span><br><span class="line">x为126：后续2个字节代表一个16位的无符号整数，该无符号整数的值为数据的长度。</span><br><span class="line">x为127：后续8个字节代表一个64位的无符号整数（最高位为0），该无符号整数的值为数据的长度。</span><br></pre></td></tr></table></figure>
<p>payload length 下面有扩展的长度。如果他超过 1 个字节，payload length 的二进制表达采用网络序（big endian，重要的位在前）</p>
<ul>
<li>Masking-key 32bit</li>
</ul>
<p>Data playload length 不包含 masking-key</p>
<ul>
<li>Playload data x+y bytes</li>
</ul>
<p>包含扩展数据和应用数据，其中扩展数据 x 字节，应用数据 y 字节</p>
<p>扩展数据：不协商使用就为 0。所有扩展数据都要声明扩展数据的长度，或者声明如何能计算出扩展数据长度。都在握手阶段协商好，如果扩展数据存在，那么 data payload length 就包含扩展数据长度</p>
<p>应用数据：任意的应用数据，在扩展数据之后。data payload length - 扩展数据长度即为应用数据长度</p>
<h3 id="掩码算法">掩码算法</h3>
<p>Masking-key 是客户端挑出的 32bit 随机数。</p>
<p>掩码和反掩码操作都用如下算法</p>
<p>定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">original-octet-i：为原始数据的第i字节；</span><br><span class="line">transformed-octet-i：为转换后的数据的第i字节；</span><br><span class="line">j：为i mod 4的结果；</span><br><span class="line">masking-key-octet-j：为mask key第j字节。</span><br></pre></td></tr></table></figure>
<p><code>original-octet-i</code>与<code>masking-key-octet-j</code>异或后得到<code>transformed-octet-i</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">j = i mod 4</span><br><span class="line">transformed-octet-i = original-octet-i XOR masking-key-octet-j</span><br></pre></td></tr></table></figure>
<p>掩码操作不会影响数据载荷的长度。</p>
<h3 id="数据掩码作用">数据掩码作用</h3>
<p>主要作用是增强协议安全性，但不是为了保护数据本身，因为算法本身就是公开的，且不复杂。实际作用是为了防止早期版本的协议中存在的代理缓存污染攻击（proxy cache poisoning attacks）等问题。</p>
<p>详细如下：<a target="_blank" rel="noopener" href="http://www.adambarth.com/papers/2011/huang-chen-barth-rescorla-jackson.pdf">Talking to Yourself for Fun and Profit</a></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/3.png" alt=""></p>
<p>整个攻击过程分为两步：</p>
<p>攻击步骤一：</p>
<ol>
<li>
<p><strong>攻击者</strong>浏览器 向 <strong>邪恶服务器</strong> 发起 WebSocket 连接。根据前文，首先是一个协议升级请求。</p>
</li>
<li>
<p>协议升级请求 实际到达 <strong>代理服务器</strong>。</p>
</li>
<li>
<p><strong>代理服务器</strong> 将协议升级请求转发到 <strong>邪恶服务器</strong>。</p>
</li>
<li>
<p><strong>邪恶服务器</strong> 同意连接，<strong>代理服务器</strong> 将响应转发给 <strong>攻击者</strong>。</p>
</li>
</ol>
<p>由于 upgrade 的实现上有缺陷，<strong>代理服务器</strong> 以为之前转发的是普通的 HTTP 消息。因此，当 <strong>邪恶服务器</strong> 同意连接，<strong>代理服务器</strong> 以为本次会话已经结束。</p>
<p>攻击步骤二：</p>
<ol>
<li>
<p><strong>攻击者</strong> 在之前建立的连接上，通过 WebSocket 的接口向 <strong>邪恶服务器</strong> 发送数据，且数据是精心构造的 HTTP 格式的文本。其中包含了 <strong>正义资源</strong> 的地址，以及一个伪造的 Host（指向 <strong>正义服务器</strong>）。</p>
</li>
<li>
<p>请求到达 <strong>代理服务器</strong>。虽然复用了之前的 TCP 连接，但 <strong>代理服务器</strong> 以为是新的 HTTP 请求。</p>
</li>
<li>
<p><strong>代理服务器</strong> 向 <strong>邪恶服务器</strong> 请求 <strong>邪恶资源</strong>（script.js）。</p>
</li>
<li>
<p><strong>邪恶服务器</strong> 返回 <strong>邪恶资源</strong>。<strong>代理服务器</strong> 缓存住 <strong>邪恶资源</strong>（url 是对的，且 Host 是 <strong>正义服务器</strong> 的地址）。</p>
</li>
</ol>
<p>到这里，受害者可以登场了：</p>
<ol>
<li>
<p><strong>受害者</strong> 通过 <strong>代理服务器</strong> 访问 <strong>正义服务器</strong> 的 <strong>正义资源</strong>。</p>
</li>
<li>
<p><strong>代理服务器</strong> 检查该资源的 url、host，发现本地有一份缓存（伪造的）。</p>
</li>
<li>
<p><strong>代理服务器</strong> 将 <strong>邪恶资源</strong> 返回给 <strong>受害者</strong>。</p>
</li>
<li>
<p><strong>受害者</strong> 卒。</p>
</li>
</ol>
<p>整个过程最大的 Bug 点是“在 upgrade 协议实现上有缺陷的代理服务器（<strong>错把 Websocket 当做是普通的 HTTP 消息</strong>）”，而数据掩码也就是为了针对这类“愚蠢”的代理服务器。因为数据掩码在每次消息传输中都由客户端随机生成，经过掩码算法后，明文消息变成了不被识别的字节，代理服务器发现每次传来的消息都不同，<strong>那它只好选择通过，而不是做缓存处理</strong>。</p>
<p>如果没有这个掩码限制，攻击者只需要在网上放个钓鱼网站骗人去访问，就可以在短时间内展开大范围攻击。安全的范围很大，防止代理缓存污染攻击也算在安全范畴内，所以不要局限于一点，这样容易进死胡同。</p>
<h2 id="数据传输">数据传输</h2>
<p>连接建立后，后续操作都是基于数据帧传递，根据 opcode 来区分操作类型</p>
<h3 id="数据分片">数据分片</h3>
<p>WebSocket 接收方每收到一个数据帧都会根据 FIN 来判断是否已经收到消息的最后一个数据帧。此时 opcode 在数据交换的场景下表示数据类型，如 0x01 位文本，0x02 为二进制。0x00 表示延续帧 continuation frame，表示完整消息对应的数据帧还没接收完。</p>
<p>🌰：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers">Writing_WebSocket_server</a></p>
<p>第一条消息表示发送的是文本类型，第二、三条消息表示完整消息未被接收完，第四条消息表示文本类型。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Client: FIN<span class="operator">=</span><span class="number">1</span>, opcode<span class="operator">=</span><span class="number">0x1</span>, msg<span class="operator">=</span>&quot;hello&quot;</span><br><span class="line">Server: (process complete message immediately) Hi.</span><br><span class="line">Client: FIN<span class="operator">=</span><span class="number">0</span>, opcode<span class="operator">=</span><span class="number">0x1</span>, msg<span class="operator">=</span>&quot;and a&quot;</span><br><span class="line">Server: (listening, <span class="keyword">new</span> message containing text started)</span><br><span class="line">Client: FIN<span class="operator">=</span><span class="number">0</span>, opcode<span class="operator">=</span><span class="number">0x0</span>, msg<span class="operator">=</span>&quot;happy new&quot;</span><br><span class="line">Server: (listening, payload concatenated <span class="keyword">to</span> previous message)</span><br><span class="line">Client: FIN<span class="operator">=</span><span class="number">1</span>, opcode<span class="operator">=</span><span class="number">0x0</span>, msg<span class="operator">=</span>&quot;year!&quot;</span><br><span class="line">Server: (process complete message) Happy <span class="keyword">new</span> <span class="keyword">year</span> <span class="keyword">to</span> you too<span class="operator">!</span></span><br></pre></td></tr></table></figure>
<h2 id="心跳">心跳</h2>
<p>引入TCP/IP的心跳、KeepAlive问题</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/4.png" alt=""></p>
<p>对应 WebSocket 操作中的 ping 和 pong，opcode 分别为 0x9、0xA。</p>
<p><a target="_blank" rel="noopener" href="http://www.52im.net/thread-2697-1-1.html">一文读懂即时通讯应用中的网络心跳包机制：作用、原理、实现思路等</a></p>
<p>在绝大部分场景中，由客户端来发送心跳是最佳实践。考虑到 Session 残留的情况：TCP 的保活机制非常不灵敏，完全不适用于正常业务场景，所以使用底层代码库实现的 max_idle_time 来限制。</p>
<h3 id="心跳保活与-idle-time">心跳保活与 idle_time</h3>
<p>通过心跳保活与 WebSocket 底层实现库设置 idle_time 来使残余 Session 关闭。在笔者的设计中，在 WS 握手成功后的连接回调函数中，会为该连接对应的 Session 设置一个 max_idle_time，后续过程中，由客户端来发送心跳保活。</p>
<p>笔者业务中使用的是原生的 websocket 包，可以看到核心代码如下：</p>
<p>在建立连接后，如果当前 endpoint 对应的 SessionMap 没有 Session（意味着当前连接是第一个连接），会创建一个后台线程，然后注册当前 Session 到内存中的 sessions 中，这是一个 map，key 和 value 存放的都是 WsSession 实例。</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/5.png" alt=""></p>
<p>其实上图走的是<code>BackgroundProcessManager.</code><em><code>getInstance</code></em><code>().register(this);</code></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/6.png" alt=""></p>
<p>在调用<code>BackgroundProcessManager.</code><em><code>getInstance</code></em><code>().register(this)</code>时，会开一个 WsBackgroundThread 线程，它的主要任务是每秒跑一次<code>manager.process()</code>，它会获取所有 process，并一一执行<code>process.backgroundProcess()</code></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/7.png" alt=""></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/8.png" alt=""></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/9.png" alt=""></p>
<p>对应到 WsWebSocketContainer 的实现，即获取每个 Session 的实例，调用 checkExpiration，下面代码贴在一起：</p>
<p>核心判断语句是：<code>(timeout &gt; 0 &amp;&amp; (currentTime - lastActiveRead) &gt; timeout &amp;&amp; (currentTime - lastActiveWrite) &gt; timeout)</code>，它检查上次读/写活跃时间是否已经超过了设定的最长空闲时间 maxIdleTimeout，如果超过，则调用 doClose 回调函数，主动关闭 Session。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// This method gets called once a second.</span></span><br><span class="line">    backgroundProcessCount ++;</span><br><span class="line">    <span class="keyword">if</span> (backgroundProcessCount &gt;= processPeriod) &#123;</span><br><span class="line">        backgroundProcessCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (WsSession wsSession : sessions.keySet()) &#123;</span><br><span class="line">            wsSession.checkExpiration();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">checkExpiration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Local copies to ensure consistent behaviour during method execution</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">timeout</span> <span class="operator">=</span> maxIdleTimeout;</span><br><span class="line">    <span class="type">long</span> <span class="variable">timeoutRead</span> <span class="operator">=</span> getMaxIdleTimeoutRead();</span><br><span class="line">    <span class="type">long</span> <span class="variable">timeoutWrite</span> <span class="operator">=</span> getMaxIdleTimeoutWrite();</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeoutRead &gt; <span class="number">0</span> &amp;&amp; (currentTime - lastActiveRead) &gt; timeoutRead) &#123;</span><br><span class="line">        key = <span class="string">&quot;wsSession.timeoutRead&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeoutWrite &gt; <span class="number">0</span> &amp;&amp; (currentTime - lastActiveWrite) &gt; timeoutRead) &#123;</span><br><span class="line">        key = <span class="string">&quot;wsSession.timeoutWrite&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout &gt; <span class="number">0</span> &amp;&amp; (currentTime - lastActiveRead) &gt; timeout &amp;&amp;</span><br><span class="line">            (currentTime - lastActiveWrite) &gt; timeout) &#123;</span><br><span class="line">        key = <span class="string">&quot;wsSession.timeout&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> sm.getString(key, getId());</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        doClose(<span class="keyword">new</span> <span class="title class_">CloseReason</span>(CloseCodes.GOING_AWAY, msg), <span class="keyword">new</span> <span class="title class_">CloseReason</span>(CloseCodes.CLOSED_ABNORMALLY, msg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于更新 lastActiveRead 与 lastActiveWrite，自然会在读写时做更新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">updateLastActiveRead</span><span class="params">()</span> &#123;</span><br><span class="line">    lastActiveRead = System.currentTimeMillis();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">updateLastActiveWrite</span><span class="params">()</span> &#123;</span><br><span class="line">    lastActiveWrite = System.currentTimeMillis();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/10.png" alt=""></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/11.png" alt=""></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/12.png" alt=""></p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/13.png" alt=""></p>
<p>以上就是 WebSocket 代码库 idle_time 实现清除参与 Session 的原理。</p>
<p>一句话来说：就是底层代码库会为 endpoint 创建 background 线程，每秒一次去 checkExpiration，主要检查 lastActiveRead 与 lastActiveWrite 是否距离当前时间已经超过了 maxIdleTimeout。</p>
<h2 id="长连接实时推送网关">长连接实时推送网关</h2>
<h3 id="解决痛点">解决痛点</h3>
<ol>
<li>
<p>技术栈不统一，开发和维护困难</p>
</li>
<li>
<p>WebSocket 实现分散在各个工程，与业务系统强耦合，其余业务需要集成时，会有重复开发、浪费成本的情况，效率低下</p>
</li>
<li>
<p>WebSocket 是有状态协议，集群需要解决共享会话功能，如果单节点部署无法水平扩展支撑更高负载，有单点风险</p>
</li>
<li>
<p>缺乏监控和报警。虽然可以通过 LinuxSocket 连接数大致估计，但是不准确，且没有业务指标数据，无法与现有微服务框架整合</p>
</li>
</ol>
<h3 id="技术目标和价值">技术目标和价值</h3>
<ol>
<li>
<p>封装 WebSocket 通信细节，与业务系统节藕，双方可以独立迭代，避免重复开发，便于开发和维护</p>
</li>
<li>
<p>提供了 HTTP 接口，便于各个其他开发语言接入，便于系统集成和使用</p>
</li>
<li>
<p>采用分布式架构，实现服务水平扩展、负载均衡和高可用</p>
</li>
<li>
<p>网关集成监控和报警，便于及时排查和解决问题</p>
</li>
</ol>
<h3 id="技术选型">技术选型</h3>
<p>选用：Netty：高性能，易扩展，社区活跃</p>
<p>WebSocket 是有状态的，无法像直接 HTTP 以集群方式实现负载均衡，长连接建立后即与服务端某个节点保持着会话，因此集群下想要得知会话属于哪个节点有点困难。</p>
<p>一般有如下两种解决方案：</p>
<ul>
<li>
<p>使用类似微服务的注册中心维护全局的会话映射问题</p>
</li>
<li>
<p>使用事件广播由各节点自行判断是否持有会话</p>
</li>
</ul>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/14.png" alt=""></p>
<p>广播实现方案，其实就是选 mq：</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/15.png" alt=""></p>
<p>在笔者所参与的项目中，由于业务场景中消息无需保证可靠，因此选用：Redis 的 Pub/Sub，少一个依赖的 mq，维护方便，实现简单。如果需要保证消息可靠，还是推荐 RocketMQ 或者 Kafka。</p>
<h3 id="实现思路">实现思路</h3>
<p>架构图：</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/16.png" alt=""></p>
<p>网关整体流程：</p>
<ol>
<li>
<p>客户端与网关任意一个 node 握手建立长连接，节点将其加入到内存维护的长连接队列（集合）中。客户端定时向服务端发送心跳，如果超过设定时间仍没有收到心跳，则认为客户端与服务端的长连接已断开，服务端回关闭连接，清理内存中会话。详见<a target="_blank" rel="noopener" href="https://anyview.fun/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3websocket%E5%8D%8F%E8%AE%AE/#%E5%BF%83%E8%B7%B3">心跳</a></p>
</li>
<li>
<p>当业务系统需要给客户端推送数据时，通过网关提供的 HTTP 接口向网关发送请求</p>
</li>
<li>
<p>将数据信息写到 mq 里</p>
</li>
<li>
<p>网关作为消费者，以广播模式消费消息，所有节点都会接收到消息。</p>
</li>
<li>
<p>节点接收到消息后判断消息目标是否在自己内存中维护的长连接队列里，如果存在则通过长连接推送数据，否则忽略</p>
</li>
</ol>
<p>当面对海量连接时，可以通过网管多节点，增加节点的方式分摊压力，实现水平扩展。如果节点宕机，客户端会尝试和其他节点握手建立长连接，保证服务整体可用。</p>
<p>会话管理：</p>
<p>每个 node 内存中维护一个哈希表，哈希表维护了 UID 和 UserSession 的关系。</p>
<p>UID 即用户 ID，UserSession 表示用户纬度的会话，一个用户困难会同时建立多个长连接，因此 UserSession 内部同样适用了一个哈希表维护一个 Channel 与 ChannelSession 的关系。</p>
<p>为了避免无止尽创建长连接，当内部 ChannelSession 数量超过一定限制后，会将最早建立的 ChannelSession 关闭，减少资源占用。</p>
<p>通过心跳保活与 WebSocket 底层实现库设置 idle_time 来使残余 Session 关闭。详见<a target="_blank" rel="noopener" href="https://anyview.fun/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3websocket%E5%8D%8F%E8%AE%AE/#%E5%BF%83%E8%B7%B3">心跳</a></p>
<p>监控和报警：</p>
<p>网关接入<a target="_blank" rel="noopener" href="https://github.com/micrometer-metrics/micrometer">micrometer</a>，将连接数和用户数作为指标暴露，供<a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus">prometheus</a>收集，使用<a target="_blank" rel="noopener" href="https://github.com/grafana/grafana">Grafana</a>来展示和报警</p>
<h3 id="负载均衡策略">负载均衡策略</h3>
<p>负载均衡策略五花八门，需要选择合适自己的业务场景来设定。简单的做法是直接 ip hash 分到不同 node 上。也可以为 WebSocket node 设一个接口获取负载情况，再做相应的决定。</p>
<p>笔者尝试了一种比较有意思的方案：<a target="_blank" rel="noopener" href="https://anyview.fun/2023/02/01/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E5%AE%9E%E6%88%98">一文了解一致性哈希</a>，仅供参考。</p>
<h3 id="压测">压测</h3>
<p>由于笔者设备能力有限，此处借用原文爱奇艺的测试数据，从下文数据可以看到，该长连接网关的性能非常优秀，足以支撑笔者业务中大部分场景，而且易横向扩展。</p>
<p>压测选择两台配置为 4 核 16G 的虚拟机，分别作为服务器和客户端。压测时选择为网关开放了 20 个端口，同时建立 20 个客户端，每个客户端使用一个服务端端口建立起 5 万连接，可以同时创建百万个连接。连接数与内存使用情况如图 3 所示。</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/17.png" alt=""></p>
<p>给百万个长连接同时发送一条消息，采用单线程发送，服务器发送完成的平均耗时在 10s 左右。</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/18.png" alt=""></p>
<p>一般同一用户同时建立的长连接都在个位数。以 10 个长连接为例，在并发数 600、持续时间 120s 条件下压测，推送接口的 TPS 大约在 1600+。</p>
<p><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/19.png" alt=""></p>
<h2 id="参考与推荐阅读">参考与推荐阅读</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/x8tjsZRuLlNYHg04aW7KFw">https://mp.weixin.qq.com/s/x8tjsZRuLlNYHg04aW7KFw</a></li>
<li><a target="_blank" rel="noopener" href="http://www.adambarth.com/papers/2011/huang-chen-barth-rescorla-jackson.pdf">http://www.adambarth.com/papers/2011/huang-chen-barth-rescorla-jackson.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_server">https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_server</a></li>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.2">RFC ft-ietf-hybi-thewebsocketprotocol: The WebSocket Protocol</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.moontalk.top/post/why-websocket-masked/">https://blog.moontalk.top/post/why-websocket-masked/</a></li>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455#section-10.3">https://datatracker.ietf.org/doc/html/rfc6455#section-10.3</a></li>
<li><a target="_blank" rel="noopener" href="http://www.52im.net/thread-3539-1-1.html">构建通用 WebSocket 推送网关的设计与实践</a></li>
<li><a target="_blank" rel="noopener" href="http://www.52im.net/thread-2697-1-1.html">http://www.52im.net/thread-2697-1-1.html</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@lancers/websocket-api-sec-websocket-protocol-subprotocol-header-support-277e34164537">https://medium.com/@lancers/websocket-api-sec-websocket-protocol-subprotocol-header-support-277e34164537</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://makonike.github.io">谈笑风生间</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://makonike.github.io/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE/">https://makonike.github.io/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://makonike.github.io" target="_blank">谈笑风生间</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a><a class="post-meta__tags" href="/tags/%E5%8D%8F%E8%AE%AE/">协议</a></div><div class="post_share"><div class="social-share" data-image="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/title.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/03/17/Linux%E7%AC%94%E8%AE%B0/" title="Linux 笔记"><img class="cover" src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/linuxbiji/title.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux 笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/01/12/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3Go%E8%AF%AD%E8%A8%80HTTP%E6%A0%87%E5%87%86%E5%BA%93/" title="一文了解 Go 语言 HTTP 标准库"><img class="cover" src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiegoyuyanhttpbiaozhuenku/title.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-12</div><div class="title">一文了解 Go 语言 HTTP 标准库</div></div></a></div><div><a href="/2023/01/29/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3Go%E8%AF%AD%E8%A8%80Sync%E6%A0%87%E5%87%86%E5%BA%93/" title="一文了解 Go 语言 Sync 标准库"><img class="cover" src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiegoyuyansyncbiaozhuenku/title.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-29</div><div class="title">一文了解 Go 语言 Sync 标准库</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/title/avatar1.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">谈笑风生间</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Makonike"><i class="fab fa-github"></i><span>Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Makonike" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:makonike@anyview.fun" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">打个胶县</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-WebSocket"><span class="toc-number">1.</span> <span class="toc-text">为什么需要 WebSocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.</span> <span class="toc-text">建立连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E8%B5%B7%E5%8D%8F%E8%AE%AE%E5%8D%87%E7%BA%A7"><span class="toc-number">3.1.</span> <span class="toc-text">客户端发起协议升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%93%8D%E5%BA%94%E5%8D%8F%E8%AE%AE%E5%8D%87%E7%BA%A7"><span class="toc-number">3.2.</span> <span class="toc-text">服务端响应协议升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sec-WebSocket-Accept-%E8%AE%A1%E7%AE%97"><span class="toc-number">3.3.</span> <span class="toc-text">Sec-WebSocket-Accept 计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sec-WebSocket-Key-Accept-%E4%BD%9C%E7%94%A8"><span class="toc-number">3.4.</span> <span class="toc-text">Sec-WebSocket-Key&#x2F;Accept 作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sec-WebSocket-Protocol-%E5%AD%90%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.5.</span> <span class="toc-text">Sec-WebSocket-Protocol 子协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B8%A7%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">数据帧格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A9%E7%A0%81%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.</span> <span class="toc-text">掩码算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8E%A9%E7%A0%81%E4%BD%9C%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">数据掩码作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="toc-number">5.</span> <span class="toc-text">数据传输</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="toc-number">5.1.</span> <span class="toc-text">数据分片</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3"><span class="toc-number">6.</span> <span class="toc-text">心跳</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%83%E8%B7%B3%E4%BF%9D%E6%B4%BB%E4%B8%8E-idle-time"><span class="toc-number">6.1.</span> <span class="toc-text">心跳保活与 idle_time</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E8%BF%9E%E6%8E%A5%E5%AE%9E%E6%97%B6%E6%8E%A8%E9%80%81%E7%BD%91%E5%85%B3"><span class="toc-number">7.</span> <span class="toc-text">长连接实时推送网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%97%9B%E7%82%B9"><span class="toc-number">7.1.</span> <span class="toc-text">解决痛点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E7%9B%AE%E6%A0%87%E5%92%8C%E4%BB%B7%E5%80%BC"><span class="toc-number">7.2.</span> <span class="toc-text">技术目标和价值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">7.3.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">7.4.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">7.5.</span> <span class="toc-text">负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E6%B5%8B"><span class="toc-number">7.6.</span> <span class="toc-text">压测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E4%B8%8E%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="toc-number">8.</span> <span class="toc-text">参考与推荐阅读</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE/" title="一文了解 WebSocket 协议"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiewebsocket/title.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一文了解 WebSocket 协议"/></a><div class="content"><a class="title" href="/2023/05/06/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE/" title="一文了解 WebSocket 协议">一文了解 WebSocket 协议</a><time datetime="2023-05-06T14:56:30.000Z" title="发表于 2023-05-06 22:56:30">2023-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/17/Linux%E7%AC%94%E8%AE%B0/" title="Linux 笔记"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/linuxbiji/title.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 笔记"/></a><div class="content"><a class="title" href="/2023/03/17/Linux%E7%AC%94%E8%AE%B0/" title="Linux 笔记">Linux 笔记</a><time datetime="2023-03-17T15:05:18.000Z" title="发表于 2023-03-17 23:05:18">2023-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/01/Raft%E8%AE%BA%E6%96%87%E7%A0%94%E8%AF%BB%E7%AC%94%E8%AE%B0/" title="Raft 论文研读笔记"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/raftlunwenyandubiji/title.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Raft 论文研读笔记"/></a><div class="content"><a class="title" href="/2023/03/01/Raft%E8%AE%BA%E6%96%87%E7%A0%94%E8%AF%BB%E7%AC%94%E8%AE%B0/" title="Raft 论文研读笔记">Raft 论文研读笔记</a><time datetime="2023-03-01T13:06:28.000Z" title="发表于 2023-03-01 21:06:28">2023-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/01/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/" title="一文了解一致性哈希"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojieyizhixinghaxi/78296349_p0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一文了解一致性哈希"/></a><div class="content"><a class="title" href="/2023/02/01/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/" title="一文了解一致性哈希">一文了解一致性哈希</a><time datetime="2023-02-01T09:57:11.000Z" title="发表于 2023-02-01 17:57:11">2023-02-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/29/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3Go%E8%AF%AD%E8%A8%80Sync%E6%A0%87%E5%87%86%E5%BA%93/" title="一文了解 Go 语言 Sync 标准库"><img src="https://makonike-blog.oss-cn-guangzhou.aliyuncs.com/blog/yiwenliaojiegoyuyansyncbiaozhuenku/title.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一文了解 Go 语言 Sync 标准库"/></a><div class="content"><a class="title" href="/2023/01/29/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3Go%E8%AF%AD%E8%A8%80Sync%E6%A0%87%E5%87%86%E5%BA%93/" title="一文了解 Go 语言 Sync 标准库">一文了解 Go 语言 Sync 标准库</a><time datetime="2023-01-29T09:01:31.000Z" title="发表于 2023-01-29 17:01:31">2023-01-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 谈笑风生间</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://icp.gov.moe/?keyword=20227404" target="_blank">萌ICP备20227404号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer src="/_vercel/insights/script.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>